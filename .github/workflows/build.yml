name: Generate Windows x64 Artifacts
on:
  push:
    branches: [main]

jobs:
  build-windows-x64:
    permissions:
      contents: write  # 必须有写入权限才能创建Release

    name: Build Windows x64
    runs-on: windows-latest
    timeout-minutes: 40
    
    steps:
      - name: Checkout yaakapp/app
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: 'src-tauri'
          shared-key: ci
          cache-on-failure: true

      - name: Install Protoc for plugin-runtime
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - run: npm ci
      - run: npm run lint
      - name: Run JS Tests
        run: npm test
      - name: Run Rust Tests
        run: cargo test --all
        working-directory: src-tauri

      - name: Set version from commit date
        shell: pwsh
        run: |
          # 获取当前提交的日期（格式化为 年.月.日，不带前导零）
          $commitDate = git show -s --format=%ci
          $date = [datetime]::Parse($commitDate)
          $year = $date.Year
          $month = $date.Month  # 自动去掉前导零
          $day = $date.Day      # 自动去掉前导零
          $formattedDate = "$year.$month.$day"
          Write-Host "Setting YAAK_VERSION to: $formattedDate"
          echo "YAAK_VERSION=$formattedDate" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Replace version in files
        run: npm run replace-version
        env:
          YAAK_VERSION: ${{ env.YAAK_VERSION }}

      - name: Disable signing in config
        shell: pwsh
        run: |
          # 读取配置文件
          $configPath = "./src-tauri/tauri.release.conf.json"
          $config = Get-Content $configPath -Raw | ConvertFrom-Json
          
          # 移除 Windows 签名命令
          if ($config.bundle.windows.PSObject.Properties.Name -contains "signCommand") {
              $config.bundle.windows.PSObject.Properties.Remove("signCommand")
              Write-Host "Removed signCommand from config"
          }
          
          # 保存修改后的配置
          $config | ConvertTo-Json -Depth 10 | Set-Content $configPath
          Write-Host "Config file updated"

      - uses: tauri-apps/tauri-action@v0
        env:
          YAAK_TARGET_ARCH: 'x64'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGN: false  # 确保禁用签名
        with:
          tagName: 'v__VERSION__'
          releaseName: 'Release __VERSION__'
          releaseBody: 'Changelog __VERSION__'
          releaseDraft: true
          prerelease: true
          args: '--config ./src-tauri/tauri.release.conf.json'

      # 新增：上传构建产物到Release
      - name: Upload artifacts to Release
        uses: softprops/action-gh-release@v1
        with:
          # 使用与tauri-action一致的版本标签格式
          tag_name: v${{ env.YAAK_VERSION }}
          name: Release v${{ env.YAAK_VERSION }}
          draft: true
          prerelease: true
          # 上传构建的所有安装包文件
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
          # Release正文（可选）
          body: |
            ### Yaak 桌面应用 v${{ env.YAAK_VERSION }}
            
            **构建信息**
            - 版本: ${{ env.YAAK_VERSION }}
            - 平台: Windows x64
            - 构建日期: ${{ github.event.head_commit.timestamp }}
            
            **安装包说明**
            - `.msi` 文件: Windows Installer 包，适合企业部署
            - `.exe` 文件: NSIS 安装程序，包含标准安装向导
            
            
